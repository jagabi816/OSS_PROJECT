<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="main-container">
      <header class="main-header">
        <h1>ğŸš€ Flask ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜</h1>
        <p class="subtitle">ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ì´ í†µí•©ëœ Flask ì• í”Œë¦¬ì¼€ì´ì…˜</p>
      </header>

      <!-- ì•Œë¦¼ ë°°ë„ˆ -->
      <div id="alertBanner" class="alert-banner-main" style="display: none;"></div>

      <main class="main-content">
        <section class="welcome-section">
          <h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2>
          <p>ì´ê²ƒì€ Flaskë¡œ ë§Œë“  ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤.</p>
          <p>ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ì„ í†µí•´ ì„œë²„ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </section>

        <section class="test-section">
          <h2>ğŸ§ª í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h2>
          <p class="section-description">ë‹¤ì–‘í•œ ìš”ì²­ì„ ë³´ë‚´ì„œ ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</p>
          
          <div class="test-buttons">
            <button class="btn btn-success" onclick="testRequest('/test/normal')">
              âœ… ì •ìƒ ìš”ì²­ í…ŒìŠ¤íŠ¸
            </button>
            <button class="btn btn-warning" onclick="testRequest('/test/slow')">
              â±ï¸ ëŠë¦° ìš”ì²­ í…ŒìŠ¤íŠ¸ (1-3ì´ˆ)
            </button>
            <button class="btn btn-danger" onclick="testRequest('/test/error')">
              âŒ ì˜¤ë¥˜ ë°œìƒ í…ŒìŠ¤íŠ¸
            </button>
            <button class="btn btn-danger" onclick="testRequest('/test/notfound')">
              ğŸ” 404 ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸
            </button>
            <button class="btn btn-danger" onclick="testRequest('/test/server-error')">
              âš ï¸ 500 ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸
            </button>
          </div>

          <div id="testResult" class="test-result"></div>
        </section>

        <section class="monitoring-link-section">
          <div class="monitoring-card">
            <h3>ğŸ“Š ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h3>
            <p>ì„œë²„ ìƒíƒœ, ìš”ì²­ í†µê³„, ì˜¤ë¥˜ ë¡œê·¸ ë“±ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <a href="/monitoring" class="btn btn-primary btn-large">
              ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì—´ê¸° â†’
            </a>
          </div>
        </section>
      </main>

      <footer class="main-footer">
        <p>Flask Monitoring Extension Project</p>
      </footer>
    </div>

    <script>
      let alertCheckInterval = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ í™•ì¸
      document.addEventListener('DOMContentLoaded', function() {
        loadAlerts();
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ì•Œë¦¼ í™•ì¸ (5ì´ˆë§ˆë‹¤)
        alertCheckInterval = setInterval(loadAlerts, 5000);
      });

      let lastAlertCount = 0;

      // ì•Œë¦¼ ë¡œë“œ
      async function loadAlerts() {
        try {
          const response = await fetch('/api/alerts?limit=5&unread_only=true');
          const alerts = await response.json();
          
          // ì•Œë¦¼ì´ ìƒˆë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
          const currentCount = alerts ? alerts.length : 0;
          const hasNewAlerts = currentCount > lastAlertCount;
          lastAlertCount = currentCount;
          
          displayAlerts(alerts, hasNewAlerts);
        } catch (error) {
          console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }

      // ì•Œë¦¼ í‘œì‹œ
      function displayAlerts(alerts, isNew = false) {
        const banner = document.getElementById('alertBanner');
        
        if (!alerts || alerts.length === 0) {
          banner.style.display = 'none';
          return;
        }

        const unreadCount = alerts.length;
        const latestAlert = alerts[0];
        
        // ìƒˆ ì•Œë¦¼ì´ ìˆìœ¼ë©´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        if (isNew) {
          banner.style.animation = 'none';
          setTimeout(() => {
            banner.style.animation = 'slideDown 0.3s ease';
          }, 10);
        }
        
        banner.innerHTML = `
          <div class="alert-content">
            <div class="alert-icon">ğŸ””</div>
            <div class="alert-text">
              <strong>${latestAlert.title}</strong>
              <span>${latestAlert.message}</span>
              ${unreadCount > 1 ? `<span class="alert-count">+${unreadCount - 1}ê°œ ë”</span>` : ''}
            </div>
            <div class="alert-actions">
              <a href="/monitoring" class="btn-alert">ìì„¸íˆ ë³´ê¸°</a>
              <button class="btn-alert-close" onclick="markAllRead()">ëª¨ë‘ ì½ìŒ</button>
            </div>
          </div>
        `;
        banner.style.display = 'block';
        banner.className = `alert-banner-main alert-${latestAlert.type}`;
        
        // ìƒˆ ì•Œë¦¼ì´ ìˆìœ¼ë©´ ë¸Œë¼ìš°ì € ì•Œë¦¼ (ê¶Œí•œ ìš”ì²­ í•„ìš”)
        if (isNew && Notification.permission === 'granted') {
          new Notification(latestAlert.title, {
            body: latestAlert.message,
            icon: '/static/favicon.ico'
          });
        }
      }

      // ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
      async function markAllRead() {
        try {
          await fetch('/api/alerts/read-all', { method: 'POST' });
          loadAlerts();
        } catch (error) {
          console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        }
      }

      // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }

      // í…ŒìŠ¤íŠ¸ ìš”ì²­ í•¨ìˆ˜
      async function testRequest(url) {
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<div class="loading">ìš”ì²­ ì¤‘...</div>';
        
        const startTime = Date.now();
        
        try {
          const response = await fetch(url);
          const endTime = Date.now();
          const duration = endTime - startTime;
          
          let result;
          if (response.ok) {
            result = await response.json();
            resultDiv.innerHTML = `
              <div class="test-success">
                <strong>âœ… ì„±ê³µ</strong><br>
                ì‘ë‹µ ì‹œê°„: ${duration}ms<br>
                <pre>${JSON.stringify(result, null, 2)}</pre>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="test-error">
                <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
                ìƒíƒœ ì½”ë“œ: ${response.status}<br>
                ì‘ë‹µ ì‹œê°„: ${duration}ms<br>
                <small>ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì—ì„œ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
              </div>
            `;
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ í™•ì¸
            setTimeout(loadAlerts, 500);
          }
        } catch (error) {
          const endTime = Date.now();
          const duration = endTime - startTime;
          resultDiv.innerHTML = `
            <div class="test-error">
              <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
              ${error.message}<br>
              ì‘ë‹µ ì‹œê°„: ${duration}ms<br>
              <small>ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì—ì„œ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
            </div>
          `;
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ í™•ì¸
          setTimeout(loadAlerts, 500);
        }
      }
    </script>
  </body>
</html>

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ” Flask Monitoring Dashboard</h1>
        <div class="header-controls">
          <button id="refreshBtn" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
          <label class="auto-refresh">
            <input type="checkbox" id="autoRefresh" />
            ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆ)
          </label>
        </div>
      </header>

      <!-- ìƒíƒœ ì¹´ë“œ -->
      <section class="status-cards">
        <div class="card">
          <div class="card-header">ì´ ìš”ì²­ ìˆ˜</div>
          <div class="card-value" id="totalRequests">-</div>
          <div class="card-footer">ì „ì²´ ìš”ì²­</div>
        </div>
        <div class="card">
          <div class="card-header">ì˜¤ë¥˜ìœ¨</div>
          <div class="card-value" id="errorRate">-</div>
          <div class="card-footer" id="errorRateFooter">-</div>
        </div>
        <div class="card">
          <div class="card-header">í‰ê·  ì‘ë‹µ ì‹œê°„</div>
          <div class="card-value" id="avgResponseTime">-</div>
          <div class="card-footer">ë°€ë¦¬ì´ˆ</div>
        </div>
        <div class="card">
          <div class="card-header">ì´ˆë‹¹ ìš”ì²­ ìˆ˜</div>
          <div class="card-value" id="requestsPerSecond">-</div>
          <div class="card-footer">RPS</div>
        </div>
        <div class="card">
          <div class="card-header">ìƒíƒœ</div>
          <div class="card-value" id="healthStatus">-</div>
          <div class="card-footer" id="uptime">-</div>
        </div>
      </section>

      <!-- í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
      <section class="test-section">
        <h2>ğŸ§ª í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h2>
        <div class="test-buttons">
          <button class="btn btn-success" onclick="testRequest('/test/normal')">
            ì •ìƒ ìš”ì²­ í…ŒìŠ¤íŠ¸
          </button>
          <button class="btn btn-warning" onclick="testRequest('/test/slow')">
            ëŠë¦° ìš”ì²­ í…ŒìŠ¤íŠ¸ (1-3ì´ˆ)
          </button>
          <button class="btn btn-danger" onclick="testRequest('/test/error')">
            ì˜¤ë¥˜ ë°œìƒ í…ŒìŠ¤íŠ¸
          </button>
          <button class="btn btn-danger" onclick="testRequest('/test/notfound')">
            404 ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸
          </button>
          <button class="btn btn-danger" onclick="testRequest('/test/server-error')">
            500 ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸
          </button>
        </div>
        <div id="testResult" class="test-result"></div>
      </section>

      <!-- ìƒì„¸ í†µê³„ -->
      <section class="stats-section">
        <h2>ğŸ“Š ìƒì„¸ í†µê³„</h2>
        <div class="stats-grid">
          <div class="stats-box">
            <h3>ì‘ë‹µ ì‹œê°„ ë°±ë¶„ìœ„ìˆ˜</h3>
            <div class="percentile-stats" id="percentileStats">-</div>
          </div>
          <div class="stats-box">
            <h3>ìƒíƒœ ì½”ë“œ ë¶„í¬</h3>
            <div class="status-codes" id="statusCodes">-</div>
          </div>
          <div class="stats-box">
            <h3>ìƒìœ„ ê²½ë¡œ</h3>
            <div class="top-paths" id="topPaths">-</div>
          </div>
          <div class="stats-box">
            <h3>ì˜¤ë¥˜ íƒ€ì…</h3>
            <div class="error-types" id="errorTypes">-</div>
          </div>
        </div>
      </section>

      <!-- ìµœê·¼ ìš”ì²­ ë¡œê·¸ -->
      <section class="requests-section">
        <h2>ğŸ“ ìµœê·¼ ìš”ì²­ ë¡œê·¸</h2>
        <div class="requests-controls">
          <input type="number" id="requestLimit" value="20" min="1" max="100" />
          <label for="requestLimit">ê°œ ìš”ì²­ í‘œì‹œ</label>
        </div>
        <div class="requests-table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ë©”ì„œë“œ</th>
                <th>ê²½ë¡œ</th>
                <th>ìƒíƒœ</th>
                <th>ì‘ë‹µ ì‹œê°„</th>
                <th>ì—”ë“œí¬ì¸íŠ¸</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr><td colspan="6">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ì—”ë“œí¬ì¸íŠ¸ë³„ í†µê³„ -->
      <section class="endpoints-section">
        <h2>ğŸ”— ì—”ë“œí¬ì¸íŠ¸ë³„ í†µê³„</h2>
        <div id="endpointsStats" class="endpoints-stats">-</div>
      </section>
    </div>

    <script>
      let autoRefreshInterval = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
      document.addEventListener('DOMContentLoaded', function() {
        loadMonitoringData();
        
        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        document.getElementById('refreshBtn').addEventListener('click', loadMonitoringData);
        
        // ìë™ ìƒˆë¡œê³ ì¹¨
        document.getElementById('autoRefresh').addEventListener('change', function(e) {
          if (e.target.checked) {
            autoRefreshInterval = setInterval(loadMonitoringData, 5000);
          } else {
            if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              autoRefreshInterval = null;
            }
          }
        });
      });

      // ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¡œë“œ
      async function loadMonitoringData() {
        try {
          // í†µê³„ ë°ì´í„°
          const statsResponse = await fetch('/monitoring/stats');
          const stats = await statsResponse.json();
          updateStats(stats);

          // ìµœê·¼ ìš”ì²­
          const limit = parseInt(document.getElementById('requestLimit').value) || 20;
          const requestsResponse = await fetch(`/monitoring/requests?limit=${limit}`);
          const requests = await requestsResponse.json();
          updateRequestsTable(requests);

          // ì—”ë“œí¬ì¸íŠ¸ í†µê³„
          const endpointsResponse = await fetch('/monitoring/endpoints');
          const endpoints = await endpointsResponse.json();
          updateEndpointsStats(endpoints);

          // í—¬ìŠ¤ ì²´í¬
          const healthResponse = await fetch('/health');
          const health = await healthResponse.json();
          updateHealthStatus(health);
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      function updateStats(stats) {
        document.getElementById('totalRequests').textContent = 
          stats.total_requests?.toLocaleString() || '0';
        
        const errorRate = (stats.error_rate * 100).toFixed(2);
        document.getElementById('errorRate').textContent = errorRate + '%';
        document.getElementById('errorRateFooter').textContent = 
          `${stats.total_errors || 0}ê°œ ì˜¤ë¥˜`;
        
        document.getElementById('avgResponseTime').textContent = 
          stats.average_response_time_ms?.toFixed(2) || '0';
        
        document.getElementById('requestsPerSecond').textContent = 
          stats.requests_per_second?.toFixed(2) || '0';

        // ë°±ë¶„ìœ„ìˆ˜
        if (stats.response_time_percentiles) {
          const p = stats.response_time_percentiles;
          document.getElementById('percentileStats').innerHTML = `
            <div>P50: <strong>${p.p50?.toFixed(2)}ms</strong></div>
            <div>P95: <strong>${p.p95?.toFixed(2)}ms</strong></div>
            <div>P99: <strong>${p.p99?.toFixed(2)}ms</strong></div>
          `;
        }

        // ìƒíƒœ ì½”ë“œ
        if (stats.status_codes) {
          const codes = Object.entries(stats.status_codes)
            .map(([code, count]) => `<span class="status-code status-${code}">${code}: ${count}</span>`)
            .join('');
          document.getElementById('statusCodes').innerHTML = codes || '-';
        }

        // ìƒìœ„ ê²½ë¡œ
        if (stats.top_paths) {
          const paths = Object.entries(stats.top_paths)
            .map(([path, count]) => `<div>${path}: <strong>${count}</strong></div>`)
            .join('');
          document.getElementById('topPaths').innerHTML = paths || '-';
        }

        // ì˜¤ë¥˜ íƒ€ì…
        if (stats.error_types && Object.keys(stats.error_types).length > 0) {
          const errors = Object.entries(stats.error_types)
            .map(([type, count]) => `<div>${type}: <strong>${count}</strong></div>`)
            .join('');
          document.getElementById('errorTypes').innerHTML = errors;
        } else {
          document.getElementById('errorTypes').textContent = 'ì˜¤ë¥˜ ì—†ìŒ';
        }
      }

      // ìš”ì²­ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateRequestsTable(requests) {
        const tbody = document.getElementById('requestsTableBody');
        if (!requests || requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">ìš”ì²­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = requests.reverse().map(req => {
          const date = new Date(req.datetime);
          const timeStr = date.toLocaleTimeString('ko-KR');
          const statusClass = req.status_code >= 500 ? 'status-error' : 
                             req.status_code >= 400 ? 'status-warning' : 'status-success';
          
          return `
            <tr class="${req.error_occurred ? 'error-row' : ''}">
              <td>${timeStr}</td>
              <td><span class="method-badge method-${req.method.toLowerCase()}">${req.method}</span></td>
              <td>${req.path}</td>
              <td><span class="status-badge ${statusClass}">${req.status_code}</span></td>
              <td>${req.duration_ms.toFixed(2)}ms</td>
              <td>${req.endpoint || '-'}</td>
            </tr>
          `;
        }).join('');
      }

      // ì—”ë“œí¬ì¸íŠ¸ í†µê³„ ì—…ë°ì´íŠ¸
      function updateEndpointsStats(endpoints) {
        const container = document.getElementById('endpointsStats');
        if (!endpoints || Object.keys(endpoints).length === 0) {
          container.textContent = 'ì—”ë“œí¬ì¸íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }

        container.innerHTML = Object.entries(endpoints).map(([endpoint, stats]) => `
          <div class="endpoint-item">
            <h4>${endpoint}</h4>
            <div class="endpoint-details">
              <div>ìš”ì²­ ìˆ˜: <strong>${stats.request_count}</strong></div>
              <div>í‰ê·  ì‘ë‹µ ì‹œê°„: <strong>${stats.average_response_time_ms.toFixed(2)}ms</strong></div>
              <div>ì˜¤ë¥˜ ìˆ˜: <strong>${stats.error_count}</strong> (${(stats.error_rate * 100).toFixed(2)}%)</div>
              <div>ìµœì†Œ/ìµœëŒ€: ${stats.min_response_time_ms.toFixed(2)}ms / ${stats.max_response_time_ms.toFixed(2)}ms</div>
            </div>
          </div>
        `).join('');
      }

      // í—¬ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateHealthStatus(health) {
        const statusEl = document.getElementById('healthStatus');
        const status = health.status || 'unknown';
        statusEl.textContent = status.toUpperCase();
        statusEl.className = `health-status health-${status}`;
        
        const uptime = Math.floor(health.uptime_seconds || 0);
        const hours = Math.floor(uptime / 3600);
        const minutes = Math.floor((uptime % 3600) / 60);
        const seconds = uptime % 60;
        document.getElementById('uptime').textContent = 
          `ê°€ë™ ì‹œê°„: ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
      }

      // í…ŒìŠ¤íŠ¸ ìš”ì²­
      async function testRequest(url) {
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<div class="loading">ìš”ì²­ ì¤‘...</div>';
        
        const startTime = Date.now();
        
        try {
          const response = await fetch(url);
          const endTime = Date.now();
          const duration = endTime - startTime;
          
          let result;
          if (response.ok) {
            result = await response.json();
            resultDiv.innerHTML = `
              <div class="test-success">
                <strong>âœ… ì„±ê³µ</strong><br>
                ì‘ë‹µ ì‹œê°„: ${duration}ms<br>
                <pre>${JSON.stringify(result, null, 2)}</pre>
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="test-error">
                <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
                ìƒíƒœ ì½”ë“œ: ${response.status}<br>
                ì‘ë‹µ ì‹œê°„: ${duration}ms
              </div>
            `;
          }
        } catch (error) {
          const endTime = Date.now();
          const duration = endTime - startTime;
          resultDiv.innerHTML = `
            <div class="test-error">
              <strong>âŒ ì˜¤ë¥˜ ë°œìƒ</strong><br>
              ${error.message}<br>
              ì‘ë‹µ ì‹œê°„: ${duration}ms
            </div>
          `;
        }
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        setTimeout(loadMonitoringData, 500);
      }
    </script>
  </body>
</html>

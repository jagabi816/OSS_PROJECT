<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flask Monitoring Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ” Flask Monitoring Dashboard</h1>
        <div class="header-controls">
          <a href="/" class="btn btn-secondary">â† ë©”ì¸ í˜ì´ì§€</a>
          <button id="refreshBtn" class="btn btn-primary">ìƒˆë¡œê³ ì¹¨</button>
          <label class="auto-refresh">
            <input type="checkbox" id="autoRefresh" />
            ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆ)
          </label>
        </div>
      </header>

      <!-- ì•Œë¦¼ ë°°ë„ˆ -->
      <div id="alertBanner" class="alert-banner" style="display: none;"></div>
      
      <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ ë°°ë„ˆ -->
      <div id="realtimeAlerts" class="realtime-alerts-container"></div>

      <!-- ìƒíƒœ ì¹´ë“œ -->
      <section class="status-cards">
        <div class="card">
          <div class="card-header">ì´ ìš”ì²­ ìˆ˜</div>
          <div class="card-value" id="totalRequests">-</div>
          <div class="card-footer">ì „ì²´ ìš”ì²­</div>
        </div>
        <div class="card" id="errorRateCard">
          <div class="card-header">ì˜¤ë¥˜ìœ¨</div>
          <div class="card-value" id="errorRate">-</div>
          <div class="card-footer" id="errorRateFooter">-</div>
        </div>
        <div class="card" id="responseTimeCard">
          <div class="card-header">í‰ê·  ì‘ë‹µ ì‹œê°„</div>
          <div class="card-value" id="avgResponseTime">-</div>
          <div class="card-footer">ë°€ë¦¬ì´ˆ</div>
        </div>
        <div class="card">
          <div class="card-header">ì´ˆë‹¹ ìš”ì²­ ìˆ˜</div>
          <div class="card-value" id="requestsPerSecond">-</div>
          <div class="card-footer">RPS</div>
        </div>
        <div class="card">
          <div class="card-header">ìƒíƒœ</div>
          <div class="card-value" id="healthStatus">-</div>
          <div class="card-footer" id="uptime">-</div>
        </div>
      </section>

      <!-- ìµœê·¼ ìš”ì²­ ë¡œê·¸ (ê°•ì¡°) -->
      <section class="requests-section">
        <div class="section-header">
          <h2>ğŸ“ ìµœê·¼ ìš”ì²­ ë¡œê·¸</h2>
          <div class="quick-filters">
            <button class="filter-btn active" data-filter="all">ì „ì²´</button>
            <button class="filter-btn" data-filter="errors">ì˜¤ë¥˜ë§Œ</button>
            <button class="filter-btn" data-filter="slow">ëŠë¦° ìš”ì²­</button>
          </div>
        </div>
        
        <div class="requests-controls">
          <div class="control-group">
            <label for="requestLimit">í‘œì‹œ ê°œìˆ˜:</label>
            <select id="requestLimit">
              <option value="10">10ê°œ</option>
              <option value="20" selected>20ê°œ</option>
              <option value="50">50ê°œ</option>
              <option value="100">100ê°œ</option>
            </select>
          </div>
          <div class="control-group">
            <label class="filter-checkbox">
              <input type="checkbox" id="hideMonitoringRequests" checked />
              ëª¨ë‹ˆí„°ë§ API ìˆ¨ê¸°ê¸°
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" id="hideFavicon" checked />
              favicon ìˆ¨ê¸°ê¸°
            </label>
          </div>
        </div>

        <div class="requests-table-container">
          <table class="requests-table">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ë©”ì„œë“œ</th>
                <th>ê²½ë¡œ</th>
                <th>ìƒíƒœ</th>
                <th>ì‘ë‹µ ì‹œê°„</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr><td colspan="5">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ìƒì„¸ í†µê³„ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
      <section class="stats-section collapsible">
        <div class="section-toggle" onclick="toggleStatsSection()">
          <h2>ğŸ“Š ìƒì„¸ í†µê³„</h2>
          <span class="toggle-icon" id="statsToggleIcon">â–¼</span>
        </div>
        <div class="stats-content" id="statsContent" style="display: none;">
          <div class="stats-grid">
            <div class="stats-box">
              <h3>ì‘ë‹µ ì‹œê°„ ë°±ë¶„ìœ„ìˆ˜</h3>
              <div class="percentile-stats" id="percentileStats">-</div>
            </div>
            <div class="stats-box">
              <h3>ìƒíƒœ ì½”ë“œ ë¶„í¬</h3>
              <div class="status-codes" id="statusCodes">-</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      let autoRefreshInterval = null;
      let currentFilter = 'all';
      let allRequests = [];

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
      document.addEventListener('DOMContentLoaded', function() {
        loadMonitoringData();
        loadAlerts();
        
        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        document.getElementById('refreshBtn').addEventListener('click', function() {
          loadMonitoringData();
          loadAlerts();
        });
        
        // ìë™ ìƒˆë¡œê³ ì¹¨
        document.getElementById('autoRefresh').addEventListener('change', function(e) {
          if (e.target.checked) {
            autoRefreshInterval = setInterval(function() {
              loadMonitoringData();
              loadAlerts();
            }, 5000);
          } else {
            if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              autoRefreshInterval = null;
            }
          }
        });

        // í•„í„° ì²´í¬ë°•ìŠ¤
        document.getElementById('hideMonitoringRequests').addEventListener('change', applyFilters);
        document.getElementById('hideFavicon').addEventListener('change', applyFilters);
        document.getElementById('requestLimit').addEventListener('change', function() {
          loadMonitoringData();
        });

        // ë¹ ë¥¸ í•„í„° ë²„íŠ¼
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            applyFilters();
          });
        });
      });

      // ìƒì„¸ í†µê³„ ì ‘ê¸°/í¼ì¹˜ê¸°
      function toggleStatsSection() {
        const content = document.getElementById('statsContent');
        const icon = document.getElementById('statsToggleIcon');
        if (content.style.display === 'none') {
          content.style.display = 'block';
          icon.textContent = 'â–²';
        } else {
          content.style.display = 'none';
          icon.textContent = 'â–¼';
        }
      }

      // ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¡œë“œ
      async function loadMonitoringData() {
        try {
          // í†µê³„ ë°ì´í„°
          const statsResponse = await fetch('/monitoring/stats');
          const stats = await statsResponse.json();
          updateStats(stats);

          // ìµœê·¼ ìš”ì²­
          const limit = parseInt(document.getElementById('requestLimit').value) || 20;
          const requestsResponse = await fetch(`/monitoring/requests?limit=${limit}`);
          const requests = await requestsResponse.json();
          allRequests = requests;
          applyFilters();

          // í—¬ìŠ¤ ì²´í¬
          const healthResponse = await fetch('/health');
          const health = await healthResponse.json();
          updateHealthStatus(health, stats);
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      function updateStats(stats) {
        document.getElementById('totalRequests').textContent = 
          stats.total_requests?.toLocaleString() || '0';
        
        const errorRate = (stats.error_rate * 100).toFixed(2);
        const errorRateEl = document.getElementById('errorRate');
        errorRateEl.textContent = errorRate + '%';
        document.getElementById('errorRateFooter').textContent = 
          `${stats.total_errors || 0}ê°œ ì˜¤ë¥˜`;
        
        // ì˜¤ë¥˜ìœ¨ì— ë”°ë¥¸ ì¹´ë“œ ìƒ‰ìƒ ë³€ê²½
        const errorCard = document.getElementById('errorRateCard');
        if (stats.error_rate > 0.1) {
          errorCard.classList.add('card-warning');
        } else if (stats.error_rate > 0.05) {
          errorCard.classList.add('card-caution');
        } else {
          errorCard.classList.remove('card-warning', 'card-caution');
        }
        
        const avgTime = stats.average_response_time_ms || 0;
        document.getElementById('avgResponseTime').textContent = avgTime.toFixed(2);
        
        // ì‘ë‹µ ì‹œê°„ì— ë”°ë¥¸ ì¹´ë“œ ìƒ‰ìƒ ë³€ê²½
        const responseCard = document.getElementById('responseTimeCard');
        if (avgTime > 1000) {
          responseCard.classList.add('card-warning');
        } else if (avgTime > 500) {
          responseCard.classList.add('card-caution');
        } else {
          responseCard.classList.remove('card-warning', 'card-caution');
        }
        
        document.getElementById('requestsPerSecond').textContent = 
          stats.requests_per_second?.toFixed(2) || '0';

        // ë°±ë¶„ìœ„ìˆ˜
        if (stats.response_time_percentiles) {
          const p = stats.response_time_percentiles;
          document.getElementById('percentileStats').innerHTML = `
            <div>P50: <strong>${p.p50?.toFixed(2)}ms</strong></div>
            <div>P95: <strong>${p.p95?.toFixed(2)}ms</strong></div>
            <div>P99: <strong>${p.p99?.toFixed(2)}ms</strong></div>
          `;
        }

        // ìƒíƒœ ì½”ë“œ
        if (stats.status_codes) {
          const codes = Object.entries(stats.status_codes)
            .map(([code, count]) => `<span class="status-code status-${code}">${code}: ${count}</span>`)
            .join('');
          document.getElementById('statusCodes').innerHTML = codes || '-';
        }
      }

      // í•„í„° ì ìš©
      function applyFilters() {
        if (!allRequests || allRequests.length === 0) return;

        const hideMonitoring = document.getElementById('hideMonitoringRequests').checked;
        const hideFavicon = document.getElementById('hideFavicon').checked;
        const monitoringPaths = ['/monitoring/stats', '/monitoring/requests', '/monitoring/endpoints', '/health'];

        let filtered = [...allRequests].reverse();

        // ëª¨ë‹ˆí„°ë§ API í•„í„°
        if (hideMonitoring) {
          filtered = filtered.filter(req => 
            !monitoringPaths.some(path => req.path.startsWith(path))
          );
        }

        // favicon í•„í„°
        if (hideFavicon) {
          filtered = filtered.filter(req => req.path !== '/favicon.ico');
        }

        // ë¹ ë¥¸ í•„í„° ì ìš©
        if (currentFilter === 'errors') {
          filtered = filtered.filter(req => req.error_occurred || req.status_code >= 400);
        } else if (currentFilter === 'slow') {
          filtered = filtered.filter(req => req.duration_ms > 1000);
        }

        updateRequestsTable(filtered);
      }

      // ìš”ì²­ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateRequestsTable(requests) {
        const tbody = document.getElementById('requestsTableBody');
        if (!requests || requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">í‘œì‹œí•  ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = requests.map(req => {
          const date = new Date(req.datetime);
          const timeStr = date.toLocaleTimeString('ko-KR');
          const statusClass = req.status_code >= 500 ? 'status-error' : 
                             req.status_code >= 400 ? 'status-warning' : 'status-success';
          
          const isMonitoringRequest = ['/monitoring/stats', '/monitoring/requests', '/monitoring/endpoints', '/health'].some(path => req.path.startsWith(path));
          const rowClass = req.error_occurred ? 'error-row' : 
                          (req.duration_ms > 1000 ? 'slow-row' : '') ||
                          (isMonitoringRequest ? 'monitoring-row' : '');
          
          return `
            <tr class="${rowClass}">
              <td>${timeStr}</td>
              <td><span class="method-badge method-${req.method.toLowerCase()}">${req.method}</span></td>
              <td>${req.path}</td>
              <td><span class="status-badge ${statusClass}">${req.status_code}</span></td>
              <td class="${req.duration_ms > 1000 ? 'slow-time' : ''}">${req.duration_ms.toFixed(2)}ms</td>
            </tr>
          `;
        }).join('');
      }

      // ì•Œë¦¼ ë¡œë“œ
      async function loadAlerts() {
        try {
          const response = await fetch('/api/alerts?limit=5&unread_only=true');
          const alerts = await response.json();
          displayRealtimeAlerts(alerts);
        } catch (error) {
          console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }

      // ì‹¤ì‹œê°„ ì•Œë¦¼ í‘œì‹œ
      function displayRealtimeAlerts(alerts) {
        const container = document.getElementById('realtimeAlerts');
        
        if (!alerts || alerts.length === 0) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = alerts.map(alert => {
          const date = new Date(alert.datetime);
          const timeStr = date.toLocaleTimeString('ko-KR');
          const alertClass = alert.type === 'error' ? 'alert-error' : 
                            alert.type === 'warning' ? 'alert-warning' : 'alert-info';
          
          return `
            <div class="realtime-alert ${alertClass}" data-alert-id="${alert.id}">
              <div class="alert-header">
                <span class="alert-type-icon">${alert.type === 'error' ? 'ğŸš¨' : 'âš ï¸'}</span>
                <span class="alert-title">${alert.title}</span>
                <span class="alert-time">${timeStr}</span>
                <button class="alert-close-btn" onclick="markAlertRead('${alert.id}')">Ã—</button>
              </div>
              <div class="alert-body">
                <p>${alert.message}</p>
                ${alert.details.path ? `<small>ê²½ë¡œ: ${alert.details.path} | ìƒíƒœ ì½”ë“œ: ${alert.details.status_code || 'N/A'}</small>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
      async function markAlertRead(alertId) {
        try {
          await fetch(`/api/alerts/${alertId}/read`, { method: 'POST' });
          loadAlerts();
        } catch (error) {
          console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        }
      }

      // í—¬ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ê²½ê³  í‘œì‹œ
      function updateHealthStatus(health, stats) {
        const statusEl = document.getElementById('healthStatus');
        const status = health.status || 'unknown';
        statusEl.textContent = status.toUpperCase();
        statusEl.className = `health-status health-${status}`;
        
        const uptime = Math.floor(health.uptime_seconds || 0);
        const hours = Math.floor(uptime / 3600);
        const minutes = Math.floor((uptime % 3600) / 60);
        const seconds = uptime % 60;
        document.getElementById('uptime').textContent = 
          `ê°€ë™ ì‹œê°„: ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;

        // ê²½ê³  ë°°ë„ˆ í‘œì‹œ
        const alertBanner = document.getElementById('alertBanner');
        const errorRate = stats.error_rate || 0;
        const avgTime = stats.average_response_time_ms || 0;
        
        let alerts = [];
        if (errorRate > 0.1) {
          alerts.push({ type: 'error', message: `âš ï¸ ì˜¤ë¥˜ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤: ${(errorRate * 100).toFixed(2)}%` });
        } else if (errorRate > 0.05) {
          alerts.push({ type: 'warning', message: `âš ï¸ ì˜¤ë¥˜ìœ¨ ì£¼ì˜: ${(errorRate * 100).toFixed(2)}%` });
        }
        if (avgTime > 1000) {
          alerts.push({ type: 'warning', message: `â±ï¸ í‰ê·  ì‘ë‹µ ì‹œê°„ì´ ëŠë¦½ë‹ˆë‹¤: ${avgTime.toFixed(2)}ms` });
        }

        if (alerts.length > 0) {
          alertBanner.innerHTML = alerts.map(a => `<div class="alert alert-${a.type}">${a.message}</div>`).join('');
          alertBanner.style.display = 'block';
        } else {
          alertBanner.style.display = 'none';
        }
      }
    </script>
  </body>
</html>
